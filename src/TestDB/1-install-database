#!/bin/bash -e

if [ $# -ne 2 ] ; then
   echo >&2 "Usage: $0 mariadb|mongodb|mysql|postgresql users.conf"
   exit 1
fi
if [ ! -e $2 ] ; then
   echo >&2 "ERROR: Use configuration $2 does not exist!"
fi

ROOT_PASSWORD="!root!"
MAINTAINER_PASSWORD="!maintainer!"
IMPORTER_PASSWORD="!importer!"
RESEARCHER_PASSWORD="!researcher!"
. ./$2

if [ "${ROOT_PASSWORD}"       = "!root!"       -o \
     "${MAINTAINER_PASSWORD}" = "!maintainer!" -o \
     "${IMPORTER_PASSWORD}"   = "!importer!"   -o \
     "${RESEARCHER_PASSWORD}" = "!researcher!" ] ; then
   echo >&2 "DO NOT USE THE EXAMPLE PASSWORDS!"
# FIXME! ????
# exit 1
fi


# ###### MariaDB ############################################################
if [ "$1" == "mariadb" ] ; then
   # Documentation: https://www.digitalocean.com/community/tutorials/how-to-install-mariadb-on-ubuntu-22-04

   echo "Installing MariaDB ..."

   ./generate-test-certificate mariadb.domain.test /etc/ssl

   sudo apt install -y mariadb-server mariadb-backup mariadb-client
   sudo mysql_secure_installation

   # Enable network access:
   sudo sed -e 's/^\(bind-address[ \t]*\)=.*$/\1= */g' /etc/mysql/mariadb.conf.d/50-server.cnf | sudo tee /etc/mysql/mariadb.conf.d/50-server.cnf.new
   sudo mv /etc/mysql/mariadb.conf.d/50-server.cnf.new /etc/mysql/mariadb.conf.d/50-server.cnf
   sudo service mariadb restart

   # Install MySQL Workbench:
   # wget https://dev.mysql.com/get/Downloads/MySQLGUITools/mysql-workbench-community_8.0.31-1ubuntu22.10_amd64.deb
   # sudo apt install ./mysql-workbench-community_8.0.31-1ubuntu22.10_amd64.deb


# ###### PostgreSQL #########################################################
elif [ "$1" == "postgresql" ] ; then
   # Documentation: https://www.digitalocean.com/community/tutorials/how-to-install-postgresql-on-ubuntu-22-04-quickstart

   echo "Installing PostgreSQL ..."

   ./generate-test-certificate postgresql.domain.test /etc/ssl

   sudo apt install -y postgresql-all postgresql-contrib

   # Enable network access:
   sudo sed \
      -e 's#^host    all             all             127.0.0.1/32            scram-sha-256#host    all             all             0.0.0.0/0               scram-sha-256#' \
      -e 's#^host    all             all             ::1/128                 scram-sha-256#host    all             all             ::/0                    scram-sha-256#' \
      /etc/postgresql/14/main/pg_hba.conf | sudo tee /etc/postgresql/14/main/pg_hba.conf.new && \
   sudo mv /etc/postgresql/14/main/pg_hba.conf.new /etc/postgresql/14/main/pg_hba.conf

   sudo sed \
      -e "s%#listen_addresses = 'localhost'%listen_addresses = '*'        %" \
      /etc/postgresql/14/main/postgresql.conf | sudo tee /etc/postgresql/14/main/postgresql.conf.new && \
   sudo mv /etc/postgresql/14/main/postgresql.conf.new /etc/postgresql/14/main/postgresql.conf

   sudo service postgresql restart


# ###### MongoDB ############################################################
elif [ "$1" == "mongodb" ] ; then
   # Documentation: https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-ubuntu/

   echo "Installing MongoDB ..."

   ./generate-test-certificate mongodb.domain.test /etc/ssl
   PEM_FILE="/etc/ssl/mongodb.domain.test-chain.pem"

   # ====== Install MongoDB =================================================
   # FIXME! Still no official MongoDB for Ubuntu 22.04 ...
   if [ ! -e libssl1.1_1.1.1f-1ubuntu2.16_amd64.deb ] ; then
      wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2.16_amd64.deb
      sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2.16_amd64.deb 
   fi
   wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | gpg --dearmor | sudo tee /usr/share/keyrings/mongodb.gpg >/dev/null
   if [ ! -e /etc/apt/sources.list.d/mongodb-org-6.0.list ] ; then
      echo "deb [ signed-by=/usr/share/keyrings/mongodb.gpg arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
   fi
   sudo apt-get update -qq
   sudo apt-get install -y mongodb-org

   # ====== Make sure there is a root user ==================================
   mongosh --quiet <<EOF
use admin
db.dropUser("root")
db.createUser({ user: "root",
                pwd: "${ROOT_PASSWORD}",
                roles: [
                   "userAdminAnyDatabase",
                   "dbAdminAnyDatabase",
                   "readWriteAnyDatabase",
                   "clusterAdmin"
                ] })
EOF

   # ====== Configure MongoDB ===============================================
   # WARNING: After installation, MongoDB does gives everybody full access!
   # The following settings enable authorization check, restricting access
   # to the configured user (root).
   cp /etc/mongod.conf /tmp/
   sudo sed \
      -e "s!  bindIp: 127.0.0.1!  ipv6: true\n  bindIpAll: true\n  tls:\n    mode: requireTLS\n    certificateKeyFile: ${PEM_FILE}\n    disabledProtocols: TLS1_0,TLS1_1,TLS1_2!" \
      -e "s!#security:!security:\n  authorization: enabled!" \
      -e "s!#  engine:!  directoryPerDB: true!" \
      -e "s!#  wiredTiger:!  wiredTiger:\n    engineConfig:\n      directoryForIndexes: true!" \
      /etc/mongod.conf | sudo tee /etc/mongod.conf.new
   sudo mv /etc/mongod.conf.new /etc/mongod.conf

   sudo systemctl restart mongod
   sudo systemctl enable mongod


# ###### Error ##############################################################
else
   echo >&2 "ERROR: Unsupported database: $1"
   exit 1
fi
