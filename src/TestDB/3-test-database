#!/bin/bash -e

if [ $# -ne 2 ] ; then
   echo >&2 "Usage: $0 mariadb|mongodb|mysql|postgresql users.conf"
   exit 1
fi
if [ ! -e $2 ] ; then
   echo >&2 "ERROR: Use configuration $2 does not exist!"
fi

MAINTAINER_PASSWORD="!maintainer!"
IMPORTER_PASSWORD="!importer!"
RESEARCHER_PASSWORD="!researcher!"
. ./$2


# ###### MongoDB ############################################################
if [ "$1" == "mongodb" ] ; then
   # Documentation: https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-ubuntu/

   echo -e "\x1b[34mTesting access to MongoDB database ...\x1b[0m"
   mongosh mongodb://localhost/pingtraceroutedb --username researcher --password "${RESEARCHER_PASSWORD}" --quiet <<EOF
use pingtraceroutedb
db.ping.countDocuments()
db.ping.findOne()
db.traceroute.countDocuments()
db.traceroute.findOne()
EOF


# ###### MySQL/MariaDB ######################################################
elif [ "$1" == "mysql" -o "$1" == "mariadb" ] ; then
   # Documentation: https://www.digitalocean.com/community/tutorials/how-to-install-mariadb-on-ubuntu-22-04

   echo -e "\x1b[34mTesting access to MySQL/MariaDB database ...\x1b[0m"
   mysql -h localhost -u researcher --password="${RESEARCHER_PASSWORD}" PingTracerouteDB <<EOF
SELECT COUNT(*) FROM Ping;
SELECT * FROM Ping LIMIT 10;
SELECT COUNT(*) FROM Traceroute;
SELECT * FROM Traceroute LIMIT 30;
EOF


# ###### PostgreSQL #########################################################
elif [ "$1" == "postgresql" ] ; then
   # Documentation: https://www.digitalocean.com/community/tutorials/how-to-install-postgresql-on-ubuntu-22-04-quickstart

   echo -e "\x1b[34mTesting access to PostgreSQL database ...\x1b[0m"
   PGPASSWORD="${RESEARCHER_PASSWORD}" psql -h localhost -d pingtraceroutedb -U researcher <<EOF
SELECT COUNT(*) FROM Ping;
SELECT * FROM Ping LIMIT 10;
SELECT COUNT(*) FROM Traceroute;
SELECT * FROM Traceroute LIMIT 30;
EOF


# ###### Error ##############################################################
else
   echo >&2 "ERROR: Unsupported database: $1"
   exit 1
fi
